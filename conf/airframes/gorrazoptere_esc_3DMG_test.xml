<airframe name="Gorrazoptere_esc_3dmg">
  <servos>
    <servo name="MOTOR_FRONT" no="0" min="0" neutral="0" max="0x3ff"/>
    <servo name="MOTOR_BACK"  no="1" min="0" neutral="0" max="0x3ff"/>
    <servo name="MOTOR_LEFT"  no="2" min="0" neutral="0" max="0x3ff"/>
    <servo name="MOTOR_RIGHT" no="3" min="0" neutral="0" max="0x3ff"/>
  </servos>

  <commands>
    <axis name="THROTTLE"  failsafe_value="0"/>
    <axis name="ROLL_DOT"  failsafe_value="0"/>
    <axis name="PITCH_DOT" failsafe_value="0"/>
    <axis name="YAW_DOT"   failsafe_value="0"/>
  </commands>

  <section name="MIXER">
    <define name="ROLL_PART"  value="0.15"/>
    <define name="PITCH_PART" value="0.15"/>
    <define name="YAW_PART"   value="0.2"/>
  </section>

  <command_laws>
    <let var="roll"     value="ROLL_PART * @ROLL_DOT"/>
    <let var="pitch"    value="PITCH_PART * @PITCH_DOT"/>
    <let var="yaw"      value="YAW_PART * @YAW_DOT"/>
    <let var="throttle" value="@THROTTLE"/>
    <set servo="MOTOR_FRONT" value="$throttle + $pitch + $yaw"/>
    <set servo="MOTOR_BACK"  value="$throttle - $pitch + $yaw"/>
    <set servo="MOTOR_RIGHT" value="$throttle + $roll  - $yaw"/>
    <set servo="MOTOR_LEFT"  value="$throttle - $roll  - $yaw"/>
  </command_laws>


<control>
  
 <level name="rate">
    <loop name="rolldot" loop_type="P" pgain="100" saturation = "MAX_PPRZ"
      data_type = "int16_t"
      measure="estimator_rolldot" setpoint="control_rolldot_setpoint" output="control_commands[COMMAND_ROLL_DOT]"/>
    <loop name="pitchdot" loop_type="P" pgain="100" saturation = "MAX_PPRZ"
      data_type = "int16_t"
      measure="estimator_pitchdot" setpoint="control_pitchdot_setpoint" output="control_commands[COMMAND_PITCH_DOT]"/>
    <loop name="yawdot" loop_type="P" pgain="100" saturation = "MAX_PPRZ"
      data_type = "int16_t"
      measure="estimator_yawdot" setpoint="control_yawdot_setpoint" output="control_commands[COMMAND_YAW_DOT]"/> 
 </level>

 
 <level name="attitude">
    <loop name="roll" loop_type="P" pgain="100" saturation = "444"
       data_type = "int16_t"
       measure="estimator_roll" setpoint="control_roll_setpoint" output="control_rolldot_setpoint"/>
    <loop name="pitch" loop_type="PID" pgain="100" dgain="200" igain="300" saturation = "444" integral_saturation = "777"
       data_type = "int16_t"
       measure="estimator_pitch" setpoint="control_pitch_setpoint" output="control_pitchdot_setpoint"/>
 </level>


  <mode name="MANUAL">
    <input input="rc_values[RADIO_THROTTLE]" output="control_commands[COMMAND_THROTTLE]" range="1"/>
    <input input="rc_values[RADIO_ROLL]" output="control_rolldot_setpoint" range="(1. * 32768000. / 8500. / 9600.)"/>
    <input input="rc_values[RADIO_PITCH]" output="control_pitchdot_setpoint" range="(1. * 32768000. / 8500. / 9600.)"/>
    <input input="rc_values[RADIO_YAW]" output="control_yawdot_setpoint" range="(1. * 32768000. / 8500. / 9600.)"/>
    <run name="rate"/>
  </mode>

  <mode name="AUTO1">
    <input input="rc_values[RADIO_THROTTLE]" output="control_commands[COMMAND_THROTTLE]" range="1"/>
    <input input="rc_values[RADIO_ROLL]" output="control_roll_setpoint" range="1"/>
    <input input="rc_values[RADIO_PITCH]" output="control_pitch_setpoint" range="1"/>
    <input input="rc_values[RADIO_YAW]" output="control_yawdot_setpoint" range="1"/>
    <run name="rate"/>
    <run name="attitude"/>
  </mode>

<!--
  <mode name="AUTO2">
    <input input="rc_values[RADIO_THROTTLE]" output="control_commands[COMMAND_THROTTLE]" range="1"/>
    <input input="rc_values[RADIO_ROLL]" output="control_setpoint_roll" range="1"/>
    <input input="rc_values[RADIO_PITCH]" output="control_setpoint_pitch" range="1"/>
    <input input="rc_values[RADIO_YAW]" output="control_setpoint_yawdot" range="1"/>
  </mode>
-->

</control>
  <makefile>
include $(PAPARAZZI_SRC)/conf/autopilot/disc_board.makefile
ap.CFLAGS += -DRADIO_CONTROL
ap.EXTRA_SRCS += radio_control.c $(SRC_ARCH)/ppm_hw.c
ap.CFLAGS += -DACTUATORS=\"servos_esc_hw.h\"
ap.EXTRA_SRCS += $(SRC_ARCH)/servos_esc_hw.c
ap.CFLAGS += -DESTIMATOR=\"estimator_3dmg.h\"
ap.EXTRA_SRCS += estimator_3dmg.c
ap.CFLAGS += -D_3DMG
ap.EXTRA_SRCS += 3dmg.c
 </makefile>
</airframe>