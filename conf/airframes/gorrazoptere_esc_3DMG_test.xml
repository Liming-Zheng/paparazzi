<airframe name="Gorrazoptere_esc_3dmg">
  <servos>
    <servo name="MOTOR_FRONT" no="0" min="0" neutral="0" max="0x3ff"/>
    <servo name="MOTOR_BACK"  no="1" min="0" neutral="0" max="0x3ff"/>
    <servo name="MOTOR_LEFT"  no="2" min="0" neutral="0" max="0x3ff"/>
    <servo name="MOTOR_RIGHT" no="3" min="0" neutral="0" max="0x3ff"/>
  </servos>

  <commands>
    <axis name="THROTTLE"  failsafe_value="0"/>
    <axis name="ROLL_DOT"  failsafe_value="0"/>
    <axis name="PITCH_DOT" failsafe_value="0"/>
    <axis name="YAW_DOT"   failsafe_value="0"/>
  </commands>

  <section name="MIXER">
    <define name="ROLL_PART"  value="0.15"/>
    <define name="PITCH_PART" value="0.15"/>
    <define name="YAW_PART"   value="0.2"/>
  </section>

  <command_laws>
    <let var="roll"     value="ROLL_PART * @ROLL_DOT"/>
    <let var="pitch"    value="PITCH_PART * @PITCH_DOT"/>
    <let var="yaw"      value="YAW_PART * @YAW_DOT"/>
    <let var="throttle" value="@THROTTLE"/>
    <set servo="MOTOR_FRONT" value="$throttle + $pitch + $yaw"/>
    <set servo="MOTOR_BACK"  value="$throttle - $pitch + $yaw"/>
    <set servo="MOTOR_RIGHT" value="$throttle + $roll  - $yaw"/>
    <set servo="MOTOR_LEFT"  value="$throttle - $roll  - $yaw"/>
  </command_laws>


<control>
  <level name="rate">
    <loop name="rolldot" loop_type="P" pgain="100" saturation = "MAX_PPRZ"
      data_type = "int16_t"
      measure="estimator_rolldot" setpoint="control_rolldot_setpoint" output="command_roll_dot"/>
    <loop name="pitchdot" loop_type="PD" pgain="100" dgain="200" saturation = "MAX_PPRZ"
      data_type = "int16_t"
      measure="estimator_pitch_dot" setpoint="setpoint_pitchdot" output="command_pitch_dot"/>
  </level>

  <level name="attitude">
    <loop name="roll" loop_type="P" pgain="100" saturation = "444"
       data_type = "int16_t"
       measure="estimator_roll" setpoint="control_roll_setpoint" output="setpoint_rolldot"/>
    <loop name="pitch" loop_type="PID" pgain="100" dgain="200" igain="300" saturation = "444" integral_saturation = "777"
       data_type = "int16_t"
       measure="estimator_pitch" setpoint="control_setpoint_pitch" output="control_setpoint_pitchdot"/>
  </level>

  <mode name="MANUAL">
    <input input="rc_values[RADIO_THROTTLE]" output="control_commands[COMMAND_THROTTLE]" range="1"/>
    <input input="rc_values[RADIO_ROLL]" output="control_setpoint_rolldot" range="(1. * 32768000. / 8500. / 9600.)"/>
    <input input="rc_values[RADIO_PITCH]" output="control_setpoint_pitchdot" range="(1. * 32768000. / 8500. / 9600.)"/>
    <input input="rc_values[RADIO_YAW]" output="control_setpoint_yawdot" range="(1. * 32768000. / 8500. / 9600.)"/>
    <run name="rate"/>
  </mode>

  <mode name="AUTO1">
    <input input="rc_values[RADIO_THROTTLE]" output="control_commands[COMMAND_THROTTLE]" range="1"/>
    <input input="rc_values[RADIO_ROLL]" output="control_setpoint_roll" range="1"/>
    <input input="rc_values[RADIO_PITCH]" output="control_setpoint_pitch" range="1"/>
    <input input="rc_values[RADIO_YAW]" output="control_setpoint_yawdot" range="1"/>
    <run name="rate"/>
    <run name="attitude"/>
  </mode>

  <mode name="AUTO2">
    <input input="rc_values[RADIO_THROTTLE]" output="control_commands[COMMAND_THROTTLE]" range="1"/>
    <input input="rc_values[RADIO_ROLL]" output="control_setpoint_roll" range="1"/>
    <input input="rc_values[RADIO_PITCH]" output="control_setpoint_pitch" range="1"/>
    <input input="rc_values[RADIO_YAW]" output="control_setpoint_yawdot" range="1"/>
  </mode>

</control>
  <makefile>
include $(PAPARAZZI_SRC)/conf/autopilot/disc_board.makefile
ap.CFLAGS += -DRADIO_CONTROL -DACTUATORS
ap.EXTRA_SRCS += radio_control.c $(SRC_ARCH)/ppm_hw.c $(SRC_ARCH)/esc.c
 </makefile>
</airframe>