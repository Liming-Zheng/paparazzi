<!-- This is a Rotating Wing Drone C
     * Airframe:    TUD00???
     * Autopilot:   Pixhawk 4 props and 1 pusher prop
     * Datalink:    Herelink
     * GPS:         UBlox F9P
     * RC:          SBUS Crossfire
-->

<airframe name="RotatingWingV3C">
    <description>RotatingWingV3C</description>

    <firmware name="rotorcraft">
        <autopilot name="rotorcraft_oneloop_with_backup.xml"/>
        <target name="ap" board="cube_orange">
            <configure VALUE="500" NAME="PERIODIC_FREQUENCY"/>
            <module TYPE="sbus" NAME="radio_control">
                <configure VALUE="UART3" NAME="SBUS_PORT"/>
            </module>
            <module NAME="sys_mon"/>
            <module NAME="flight_recorder"/>
            <module TYPE="ms45xx_i2c" NAME="airspeed">
                <define NAME="USE_I2C2"/>
                <define VALUE="i2c2" NAME="MS45XX_I2C_DEV"/>
                <define NAME="MS45XX_LOWPASS_TAU" value="0.15"/>
                <define NAME="MS45XX_AIRSPEED_SCALE" value="2.9605"/>
                <define NAME="USE_AIRSPEED_LOWPASS_FILTER" value="TRUE"/>
            </module>

            <module name="airspeed" type="uavcan"/>

            <module name="lidar_tfmini">
                <configure name="TFMINI_PORT" value="UART8"/>
                <configure name="USE_TFMINI_AGL" value="TRUE"/>
            </module>     
            <define VALUE="RADIO_AUX1" NAME="RADIO_TH_HOLD"/>
            <define VALUE="RADIO_AUX2" NAME="RADIO_FMODE"/>
            <define VALUE="RADIO_AUX3" NAME="RADIO_FBW_MODE"/>
            <define VALUE="RADIO_AUX1" NAME="RADIO_KILL_SWITCH"/>
            <define VALUE="MAG_RM3100_SENDER_ID" NAME="INS_EKF2_MAG_ID" />
            <define VALUE="IMU_CUBE2_ID" NAME="INS_EKF2_ACCEL_ID"/>
            <define VALUE="IMU_CUBE1_ID" NAME="INS_EKF2_GYRO_ID"/>
            <define name="I2C2_CLOCK_SPEED" value="100000"/>
        </target>

        <target name="nps" board="pc">
            <module name="radio_control" type="datalink"/>
            <module name="fdm" type="jsbsim"/>
            <!--Not dealing with these in the simulation-->
            <define name="RADIO_TH_HOLD"     value="0"/> <!-- Throttle hold in command laws -->
            <define name="RADIO_FMODE"       value="0"/> <!-- Throttle curve select -->
            <define name="RADIO_FBW_MODE"    value="0"/> <!-- Switch between AP and FBW control -->
            <define name="RADIO_KILL_SWITCH" value="5"/>
        </target>

        <module TYPE="transparent" NAME="telemetry">
            <configure VALUE="B115200" NAME="MODEM_BAUD"/> <!-- herelink-->
            <!-- <configure VALUE="B57600" NAME="MODEM_BAUD"/> xBee -->
        </module>

        <module TYPE="uavcan" NAME="actuators">
            <configure VALUE="TRUE" NAME="UAVCAN_USE_CAN1"/>
            <configure VALUE="TRUE" NAME="UAVCAN_USE_CAN2"/>
        </module>

        <module TYPE="pwm" NAME="actuators">
            <define name="SERVO_HZ" value="400"/>
        </module>

        <module name="imu" type="cube"/>

        <module name="gps"           type="ublox">
            <configure name="UBX_GPS_BAUD" value="B460800"/>
            <define name="USE_GPS_UBX_RTCM" value="TRUE"/>
        </module>

        <module name="stabilization" type="oneloop" >
            <configure name="INDI_NUM_ACT" value="8"/>
        </module>

        <module name="guidance" type="oneloop"/>
        <module name="nav_hybrid"/>

        <module TYPE="ekf2" NAME="ins"/>
        <module name="oneloop" type="andi">
            <configure name="ANDI_NUM_ACT_TOT" value="7"/>
            <configure name="ANDI_NUM_ACT" value="5"/>
            <configure name="ANDI_NUM_VIRTUAL_ACT" value="2"/>
            <configure name="ANDI_OUTPUTS" value="6"/>
        </module>
        <module NAME="air_data"/>

         <module name="mag" type="rm3100">
            <define name="MODULE_RM3100_UPDATE_AHRS" value="TRUE"/>
            <configure name="MAG_RM3100_I2C_DEV" value="I2C2"/>
        </module>
        
        <module name="wls">
            <define name="WLS_N_U" value = "7"/>
            <define name="WLS_N_V" value = "6"/>
        </module>
        <module name="AOA_pwm">
            <define name="USE_PWM_INPUT1" value="PWM_PULSE_TYPE_ACTIVE_LOW"/>
            <define name="AOA_ANGLE_OFFSET" value="3.5807"/>
            <define name="AOA_PWM_PERIOD" value="1024"/>
            <define name="AOA_PWM_OFFSET" value="1"/>
            <configure name="AOA_PWM_CHANNEL" value="PWM_INPUT1" />
        </module>

        <module name="wing_rotation_controller_v3b">
            <define name="WING_ROTATION_POSITION_ADC_0" value="62930"/>
            <define name="WING_ROTATION_POSITION_ADC_90" value="41760"/>
            <define name="WING_ROTATION_DEADZONE_PPRZ_CMD" value="500"/>
            <define name="WING_ROTATION_P_GAIN" value="-50000"/>
            <define name="WING_ROTATION_MAX_CMD" value="9600"/>
            <define name="WING_ROTATION_RESET_RADIO_CHANNEL" value="10"/>
        </module>

        <module name="agl_dist"/>
        <module name="navigation_oneloop"/>

    </firmware>

    <servos DRIVER="Pwm">
        <servo NO="0" NAME="SERVO_ROTWING"   MIN="1031" NEUTRAL="1330" MAX="2260"/>
    </servos>

    <servos DRIVER="Uavcan1">
        <servo NO="0" NAME="MOTOR_FRONT"    MIN="0"     NEUTRAL="600" MAX="8191"/>
        <servo NO="1" NAME="MOTOR_RIGHT"    MIN="0"     NEUTRAL="600" MAX="8191"/>
        <servo NO="2" NAME="MOTOR_BACK"     MIN="0"     NEUTRAL="600" MAX="8191"/>
        <servo NO="3" NAME="MOTOR_LEFT"     MIN="0"     NEUTRAL="600" MAX="8191"/>
        <servo NO="4" NAME="MOTOR_PUSH"     MIN="0"     NEUTRAL="200"    MAX="6552"/>
        <servo NO="5" NAME="SERVO_ELEVATOR" MIN="4000"  NEUTRAL="4000" MAX="-5500"/>
        <servo NO="6" NAME="SERVO_RUDDER"   MIN="-8191" NEUTRAL="0"    MAX="8191"/>
    </servos>

    <servos DRIVER="Uavcan2">
        <servo NO="0" NAME="BMOTOR_FRONT" MIN="0" NEUTRAL="600" MAX="8191"/>
        <servo NO="1" NAME="BMOTOR_RIGHT" MIN="0" NEUTRAL="600" MAX="8191"/>
        <servo NO="2" NAME="BMOTOR_BACK"  MIN="0" NEUTRAL="600" MAX="8191"/>
        <servo NO="3" NAME="BMOTOR_LEFT"  MIN="0" NEUTRAL="600" MAX="8191"/>
    </servos>

    <!-- CAN BUS 1 command outputs-->
    <servos driver="Uavcan2Cmd">
        <servo name="AIL_LEFT" no="7" min="-3250" neutral="0" max="3250"/> <!-- min can go up to -9600-->
        <servo name="FLAP_LEFT" no="8" min="-3250" neutral="0" max="3250"/> <!-- min can go up to -9600-->
        <servo name="FLAP_RIGHT" no="9" min="-3250" neutral="0" max="3250"/> <!-- max can go up to -9600-->
        <servo name="AIL_RIGHT" no="10" min="-3250" neutral="0" max="3250"/> <!-- max can go up to -9600-->
    </servos>

    <commands>
        <axis NAME="ROLL"   FAILSAFE_VALUE="0"/>
        <axis NAME="PITCH"  FAILSAFE_VALUE="0"/>
        <axis NAME="YAW"    FAILSAFE_VALUE="0"/>
        <axis NAME="THRUST" FAILSAFE_VALUE="0"/>
    </commands>

    <rc_commands>
        <set VALUE="@THROTTLE" COMMAND="THRUST"/>
        <set VALUE="@ROLL" COMMAND="ROLL"/>
        <set VALUE="@PITCH" COMMAND="PITCH"/>
        <set VALUE="@YAW" COMMAND="YAW"/>
    </rc_commands>

    <command_laws>
        <let VAR="th_hold" VALUE="Or(LessThan(RadioControlValues(RADIO_TH_HOLD), -4800), !autopilot_get_motors_on())"/>
        <set VALUE="($th_hold? -9600 : actuators_pprz[0])"           SERVO="MOTOR_FRONT"/>
        <set VALUE="($th_hold? -9600 : actuators_pprz[1])"           SERVO="MOTOR_RIGHT"/>
        <set VALUE="($th_hold? -9600 : actuators_pprz[2])"           SERVO="MOTOR_BACK"/>
        <set VALUE="($th_hold? -9600 : actuators_pprz[3])"           SERVO="MOTOR_LEFT"/>
        <set VALUE="($th_hold?     0 : actuators_pprz[5])"           SERVO="SERVO_RUDDER"/>
        <set VALUE="(!autopilot_in_flight()? 0 : actuators_pprz[6])" SERVO="SERVO_ELEVATOR"/>
        <set VALUE="($th_hold? -9600 : actuators_pprz[4])"           SERVO="MOTOR_PUSH"/>
        <set VALUE=" wing_rotation.servo_pprz_cmd"                   SERVO="SERVO_ROTWING"/>
        <set VALUE="($th_hold? 0 : actuators_pprz[7])"               SERVO="AIL_LEFT"/>
        <set VALUE="($th_hold? 0 : actuators_pprz[7])"               SERVO="AIL_RIGHT"/>
        <set VALUE="($th_hold? 0 : actuators_pprz[8])"               SERVO="FLAP_LEFT"/>
        <set VALUE="($th_hold? 0 : actuators_pprz[8])"               SERVO="FLAP_RIGHT"/>

        <!-- Backup commands -->
        <set VALUE="($th_hold? -9600 : actuators_pprz[0])" SERVO="BMOTOR_FRONT"/>
        <set VALUE="($th_hold? -9600 : actuators_pprz[1])" SERVO="BMOTOR_RIGHT"/>
        <set VALUE="($th_hold? -9600 : actuators_pprz[2])" SERVO="BMOTOR_BACK"/>
        <set VALUE="($th_hold? -9600 : actuators_pprz[3])" SERVO="BMOTOR_LEFT"/>
    </command_laws>

    <section NAME="MISC">
        <define name="VoltageOfAdc(adc)" value="((3.3f/65536.0f) * 13.86 * adc)"/>
        <define VALUE="TRUE" NAME="NO_RC_THRUST_LIMIT"/>
        <define VALUE="2.0" NAME="NAV_CLIMB_VSPEED"/>
        <define VALUE="-1.0" NAME="NAV_DESCEND_VSPEED"/>
        <define name="NAV_CARROT_DIST" value="150"/>
        <define name="THRESHOLD_GROUND_DETECT" value="40"/>
        <define name="AUTOPILOT_IN_FLIGHT_MIN_THRUST" value="500"/>
        <define VALUE="50.0" NAME="ARRIVED_AT_WAYPOINT"/>
        <define VALUE="20" NAME="NO_GPS_LOST_WITH_DATALINK_TIME"/>
        <define VALUE="TRUE" NAME="NO_GPS_LOST_WITH_RC_VALID"/>
        <define name="USE_AIRSPEED" value="TRUE"/>
        <define VALUE="45." UNIT="deg"   NAME="STABILIZATION_ATTITUDE_SP_MAX_PHI"/> 
        <define VALUE="45." UNIT="deg"   NAME="STABILIZATION_ATTITUDE_SP_MAX_THETA"/>
        <define VALUE="90." UNIT="deg/s" NAME="STABILIZATION_ATTITUDE_SP_MAX_R"/>
        <define VALUE="200"              NAME="STABILIZATION_ATTITUDE_DEADBAND_R"/>
        <define name="GUIDANCE_INDI_MAX_AIRSPEED"          value = "5.0f"/> <!--remove once hybrid nav is made not dependent on guidance indi hybrid-->
        <define name="GUIDANCE_INDI_NAV_SPEED_MARGIN"      value = "0.0"/>  <!--remove once hybrid nav is made not dependent on guidance indi hybrid-->
    </section>

    <section name="IMU" prefix="IMU_">
        <!-- For some reason accel calibration does not work in JSBSIM. Cannot solve simply in NPS section. -->
        <!-- <define name="ACCEL_CALIB" value="{{.abi_id=20, .calibrated={.neutral=true, .scale=true},.neutral={-12,-9,20}, .scale={{30726,37910,15728},{3133,3871,1611}}}, {.abi_id=21, .calibrated={.neutral=true, .scale=true},.neutral={-9,-30,26}, .scale={{45288,818,33359},{8935,167,6832}}}, {.abi_id=22, .calibrated={.neutral=true, .scale=true},.neutral={-35,-5,13}, .scale={{26152,56165,62837},{5357,11479,12884}}}}"/> -->
        <define name="MAG_CALIB" value="{{.abi_id=5, .calibrated={.neutral=true, .scale=true},.neutral={-14,3,42}, .scale={{17279,2209,36874},{30247,3800,64095}}}}"/>
        <define name="BODY_TO_IMU_PHI"   value="0." unit="deg"/>
        <define name="BODY_TO_IMU_THETA" value="0." unit="deg"/>
        <define name="BODY_TO_IMU_PSI"   value="0." unit="deg"/>
    </section>

    <section PREFIX="ONELOOP_ANDI_" NAME="ONELOOP_ANDI">
        <define name  = "G1_ROLL"                   value = "{ 0.0f,   -15.0f,   0.0f,    15.0f,  0.0f,  0.0f, 0.0f}"/>
        <define name  = "G1_PITCH"                  value = "{ 1.5f,    0.0f,   -1.5f,    0.0f,   0.0f,  0.0f, 0.0f}"/>  
        <define name  = "G1_YAW"                    value = "{-0.3f,    0.3f,   -0.3f,    0.3f,   0.0f,  0.0f, 0.0f}"/>
        <define name  = "G1_THRUST"                 value = "{-0.575f, -0.575f, -0.575f, -0.575f, 0.55f, 0.0f, 0.0f}"/>  
        <define name  = "G1_ZERO"                   value = "{ 0.0f,    0.0f,    0.0f,    0.0f,   0.0f,  0.0f, 0.0f}"/> 
        <define name  = "G2"                        value = "{ 0.0f,    0.0f,    0.0f,    0.0f,   0.0f,  0.0f, 0.0f}"/>
        <define name  = "MAX_R"                     value = "120.0" unit="deg/s"/>
        <define name  = "FILT_CUTOFF"               value = "5.0" />
        <define name  = "FILT_CUTOFF_ACC"           value = "5.0"/>
        <define name  = "FILT_CUTOFF_VEL"           value = "10.0"/>
        <define name  = "FILT_CUTOFF_POS"           value = "10.0"/>
        <define name  = "ESTIMATION_FILT_CUTOFF"    value = "3.2" />
        <define name  = "FILT_CUTOFF_P"             value = "5.0"/>
        <define name  = "FILT_CUTOFF_Q"             value = "5.0"/>
        <define name  = "FILT_CUTOFF_R"             value = "5.0" />
        <define name  = "FILT_CUTOFF_RDOT"          value = "0.5" />
        <define name  = "FILTER_YAW_RATE"           value = "TRUE"/>
        <define name  = "ACT_DYN"                   value = "{10.1f, 10.1f, 10.1f, 10.1f, 24.07f, 0.0f,0.0f}" />
        <define name  = "ACT_IS_SERVO"              value = "{0, 0, 0, 0, 0, 0, 0}" />
        <define name  = "ACT_MAX"                   value = "{9600.0f, 9600.0f,  9600.0f,  9600.0f, 9600.0f,  M_PI_4,  M_PI_4}"/>
        <define name  = "ACT_MIN"                   value = "{0.0f   ,    0.0f,     0.0f,     0.0f,    0.0f, -M_PI_4, -M_PI_4}"/>
        <define name  = "ACT_MAX_NORM"              value = "{1.0f   ,    1.0f,     1.0f,     1.0f,    1.0f,    1.0f,    1.0f}"/>
        <define name  = "ACT_MIN_NORM"              value = "{0.0f   ,    0.0f,     0.0f,     0.0f,    0.0f,   -1.0f,   -1.0f}"/>
        <define name  = "DEBUG_MODE"                value = "FALSE"/>
        <define name  = "AC_HAS_PUSHER"             value = "TRUE"/>
        <define name  = "PUSHER_IDX"                value = "4"/>
        <define name  = "WV"                        value = "{1.0f, 1.0f, 1.0f, 1000.0f, 1000.0f, 100.0f}"/>
        <define name  = "WU"                        value = "{3.0f, 3.0f, 3.0f, 3.0f, 1.0f, 2.0f, 2.0f}"/>
        <define name  = "U_PREF"                    value = "{0.0f, 0.0f, 0.0f, 0.0f, 0.0f, 0.0f, 0.0f}"/>
        <define name  = "MAX_AIRSPEED"              value = "5.0f"/>
    </section>

    <section NAME="AUTOPILOT">
        <define VALUE="AP_MODE_ATTITUDE_DIRECT"         NAME="MODE_MANUAL"/>
        <define VALUE="AP_MODE_MODULE"                  NAME="MODE_AUTO1"/>
        <define VALUE="AP_MODE_NAV"                     NAME="MODE_AUTO2"/>
        <define VALUE="AP_MODE_ATTITUDE_DIRECT"         NAME="MODE_STARTUP"/>
        <define name="USE_KILL_SWITCH_FOR_MOTOR_ARMING" value="TRUE"/>
    </section>

    <section NAME="BAT">
        <define VALUE="18.0" UNIT="V" NAME="CATASTROPHIC_BAT_LEVEL"/>
        <define VALUE="18.6" UNIT="V" NAME="CRITIC_BAT_LEVEL"/>
        <define VALUE="19.2" UNIT="V" NAME="LOW_BAT_LEVEL"/>
        <define VALUE="25.2" UNIT="V" NAME="MAX_BAT_LEVEL"/>
        <define VALUE="6"             NAME="BAT_NB_CELLS"/>
    </section>

    <section name="SIMULATOR" prefix="NPS_">
        <define name="ACTUATOR_NAMES"  value="front_motor, right_motor, back_motor, left_motor, pusher, rudder, elevator, aileron_left, aileron_right" type="string[]"/>
        <define name="JSBSIM_MODEL"    value="rotwingv3c" type="string"/>
        <define name="SENSORS_PARAMS"  value="nps_sensors_params_default.h" type="string"/>
        <define name="COMMANDS_NB"     value="9"/>
        <define name="NO_MOTOR_MIXING" value="TRUE"/>
        <define name="JS_AXIS_MODE"    value="4"/>
    </section>
</airframe>
