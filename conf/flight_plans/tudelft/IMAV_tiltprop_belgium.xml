<!DOCTYPE flight_plan SYSTEM "../flight_plan.dtd">

<flight_plan alt="260" ground_alt="0" lat0="50.7291675" lon0="5.8873805" max_dist_from_home="1600" name="Rotorcraft Basic (Enac)" security_height="2">
  <header>
#include "autopilot.h"
</header>
  <waypoints>
    <waypoint name="HOME" x="0" y="0"/>
    <waypoint name="CLIMB" x="-6.8" y="-24.3"/>
    <waypoint name="STDBY" x="155.2" y="-17.8"/>
    <waypoint lat="50.729921" lon="5.886568" name="p1"/>
    <waypoint lat="50.730552" lon="5.887398" name="p2"/>
    <waypoint lat="50.730456" lon="5.889711" name="p3"/>
    <waypoint lat="50.729452" lon="5.889359" name="p4"/>
    <waypoint lat="50.728351" lon="5.885521" name="h1"/>
    <waypoint lat="50.727090" lon="5.888642" name="h2"/>
    <waypoint lat="50.728902" lon="5.891478" name="h3"/>
    <waypoint lat="50.729938" lon="5.889121" name="h4"/>
    <waypoint alt="250.0" lat="50.728351" lon="5.885521" name="L1"/>
    <waypoint alt="235.0" lat="50.727090" lon="5.888642" name="L2"/>
    <waypoint alt="220.0" lat="50.728902" lon="5.891478" name="L3"/>
    <waypoint alt="210.0" lat="50.729938" lon="5.889121" name="L4"/>
    <waypoint lat="50.728549" lon="5.890849" name="START" height="70"/>
    <waypoint name="GOAL" x="43.1" y="-56.5"/>
    <waypoint name="TRAJECTORY" x="47.5" y="-43.8"/>
    <waypoint alt="210" lat="50.7290641" lon="5.8873910" name="TD"/>
    <waypoint lat="50.732065" lon="5.884914" name="A"/>
    <waypoint lat="50.729770" lon="5.882619" name="B"/>
    <waypoint lat="50.725393" lon="5.873334" name="C"/>
    <waypoint lat="50.722190" lon="5.867498" name="D"/>
    <waypoint lat="50.717813" lon="5.869879" name="E"/>
    <waypoint lat="50.715078" lon="5.873857" name="F"/>
    <waypoint lat="50.717190" lon="5.878342" name="G"/>
    <waypoint lat="50.724153" lon="5.888522" name="H"/>
    <waypoint lat="50.723996" lon="5.901567" name="J"/>
    <waypoint lat="50.729355" lon="5.901615" name="K"/>
    <waypoint lat="50.733158" lon="5.896488" name="L"/>
    <waypoint lat="50.731179" lon="5.889759" name="M"/>
  </waypoints>
  <sectors>
    <sector color="green" name="Geofence">
      <corner name="A"/>
      <corner name="B"/>
      <corner name="C"/>
      <corner name="D"/>
      <corner name="E"/>
      <corner name="F"/>
      <corner name="G"/>
      <corner name="H"/>
      <corner name="J"/>
      <corner name="K"/>
      <corner name="L"/>
      <corner name="M"/>
    </sector>
  </sectors>
  <exceptions>
    <exception cond="Or(!InsideGeofence(GetPosX(), GetPosY()), GetPosAlt() @GT GetAltRef() + 200) @AND !(nav_block == IndexOfBlock('Wait GPS'))
      @AND (nav_block @LT IndexOfBlock('landed')) @AND !(nav_block @LT IndexOfBlock('Holding point'))
      @AND !(nav_block == IndexOfBlock('Holding point'))" deroute="Terminate"/>
    <exception cond="(GpsIsLost() @AND (nav_block @GT IndexOfBlock('Standby'))
      @AND (nav_block @LT IndexOfBlock('landed')))" deroute="No_GPS_Connection"/>
  </exceptions>
  <blocks>
    <block name="Wait GPS">
      <call_once fun="NavKillThrottle()"/>
      <while cond="!GpsFixValid()"/>
    </block>
    <block name="Geo init">
      <while cond="LessThan(NavBlockTime(), 1)"/>
      <call_once fun="NavSetGroundReferenceHere()"/>
    </block>
    <block name="Holding point">
      <call_once fun="NavKillThrottle()"/>
      <attitude pitch="0" roll="0" throttle="0" until="FALSE" vmode="throttle"/>
    </block>
    <block name="Automatic Takeoff">
      <call_once fun="NavResurrect()"/>
      <call_once fun="take_off_enter()"/>
      <attitude alt="5" pitch="0" roll="0" until="GetPosHeight() @GT 2.0"/>
    </block>
    <block name="Takeoff" strip_button="Takeoff" strip_icon="takeoff.png">
      <exception cond="GetPosHeight() @GT 15.0" deroute="route"/>
      <call_once fun="NavSetWaypointHere(WP_CLIMB)"/>
      <stay climb="nav_climb_vspeed" vmode="climb" wp="CLIMB"/>
    </block>
    <block name="route">
      <set value="true" var="force_forward"/>
      <while cond="true">
        <go wp="h1"/>
        <go from="h1" hmode="route" wp="h2"/>
        <go from="h2" hmode="route" wp="h3"/>
        <go from="h3" hmode="route" wp="h4"/>
        <go from="h4" hmode="route" wp="h1"/>
      </while>
      <deroute block="stay_h1"/>
    </block>
    <block name="Standby" strip_button="Standby" strip_icon="home.png">
      <set value="false" var="force_forward"/>
      <stay wp="STDBY"/>
    </block>
    <block name="stay_h1">
      <set value="false" var="force_forward"/>
      <stay wp="h1"/>
    </block>
    <block name="go_p2">
      <set value="false" var="force_forward"/>
      <go wp="p2"/>
      <deroute block="stay_h1"/>
    </block>
    <block name="LowerALT">
      <set value="true" var="force_forward"/>
      <go wp="L1"/>
      <go wp="L2"/>
      <go wp="L3"/>
      <go wp="L4"/>
      <deroute block="land"/>
    </block>
    <block name="go_start">
      <set value="false" var="force_forward"/>
      <go wp="START"/>
      <deroute block="route"/>
    </block>
    <block name="4waypoints">
      <set value="true" var="force_forward"/>
      <go wp="p1"/>
      <go wp="p2"/>
      <go wp="p3"/>
      <go wp="p4"/>
      <go wp="START"/>
      <deroute block="route"/>
    </block>
    <block name="land here" strip_button="Land Here" strip_icon="land-right.png">
      <call_once fun="NavSetWaypointHere(WP_TD)"/>
      <deroute block="flare"/>
    </block>
    <block name="land">
      <set value="false" var="force_forward"/>
      <go vmode="alt" wp="TD"/>
    </block>
    <block name="flare">
      <exception cond="LessThan(agl_dist_value_filtered, 0.15) @AND agl_dist_valid" deroute="landed"/>
      <stay climb="nav_descend_vspeed" vmode="climb" wp="TD"/>
    </block>
    <block name="landed">
      <attitude pitch="0" roll="0" throttle="0" until="FALSE" vmode="throttle"/>
    </block>
    <block name="return home">
      <set value="false" var="force_forward"/>
      <go wp="STDBY"/>
    </block>
    <block name="Terminate">
      <call_once fun="NavKillThrottle()"/>
      <set value="false" var="force_forward"/>
      <set value="true" var="terminate_flight"/>
      <attitude pitch="0" roll="0" throttle="0" until="FALSE" vmode="throttle"/>
    </block>
    <block name="No_GPS_Connection">
      <attitude climb="-1" pitch="0" roll="0" vmode="climb"/>
      <exception cond="NavBlockTime() @GT 15" deroute="Terminate"/>
    </block>
  </blocks>
</flight_plan>
