<!DOCTYPE flight_plan SYSTEM "../flight_plan.dtd">

<flight_plan alt="70" ground_alt="0" lat0="50.714955" lon0="5.900670" max_dist_from_home="1300" name="Rotorcraft Basic (Enac)" security_height="2">
  <header>
#include "autopilot.h"
</header>
  <waypoints>
    <waypoint name="HOME" x="0.0" y="0.0"/>
    <waypoint name="CLIMB" x="-39.0" y="17.6"/>
    <waypoint name="STDBY" x="-29.1" y="-47.5"/>
    <waypoint lat="50.716569" lon="5.893181" name="p1"/>
    <waypoint lat="50.717996" lon="5.894865" name="p2"/>
    <waypoint lat="50.715705" lon="5.895292" name="p3"/>
    <waypoint lat="50.713760" lon="5.896266" name="p4"/>
    <waypoint lat="50.715144" lon="5.891024" name="h1"/>
    <waypoint lat="50.717903" lon="5.895903" name="h2"/>
    <waypoint lat="50.716302" lon="5.899203" name="h3"/>
    <waypoint lat="50.713192" lon="5.894472" name="h4"/>
    <waypoint lat="50.715144" lon="5.891024" alt="55" name="L1"/>
    <waypoint lat="50.717903" lon="5.895903" alt="40" name="L2"/>
    <waypoint lat="50.716302" lon="5.899203" alt="30" name="L3"/>
    <waypoint lat="50.713192" lon="5.894472" alt="15" name="L4"/>
    <waypoint lat="50.716057" lon="5.897104" name="START"/>
    <waypoint name="GOAL" x="1.9" y="1.0"/>
    <waypoint name="TRAJECTORY" x="1.9" y="1.0"/>
    <waypoint name="TD" x="-25.4" y="34.0"/>
    <waypoint lat="50.721287" lon="5.896945" name="A"/>
    <waypoint lat="50.719103" lon="5.892398" name="B"/>
    <waypoint lat="50.716440" lon="5.888566" name="C"/>
    <waypoint lat="50.711922" lon="5.883399" name="D"/>
    <waypoint lat="50.711264" lon="5.886377" name="E"/>
    <waypoint lat="50.711291" lon="5.893099" name="F"/>
    <waypoint lat="50.711666" lon="5.898816" name="G"/>
    <waypoint lat="50.712919" lon="5.900822" name="H"/>
    <waypoint lat="50.715047" lon="5.902306" name="J"/>
    <waypoint lat="50.716857" lon="5.906448" name="K"/>
    <waypoint lat="50.717694" lon="5.902928" name="L"/>
    <waypoint lat="50.718487" lon="5.899484" name="M"/>
  </waypoints>
  <sectors>
    <sector color="green" name="Geofence">
      <corner name="A"/>
      <corner name="B"/>
      <corner name="C"/>
      <corner name="D"/>
      <corner name="E"/>
      <corner name="F"/>
      <corner name="G"/>
      <corner name="H"/>
      <corner name="J"/>
      <corner name="K"/>
      <corner name="L"/>
      <corner name="M"/>
    </sector>
  </sectors>
  <exceptions>
    <exception cond="Or(!InsideGeofence(GetPosX(), GetPosY()), GetPosAlt() @GT GetAltRef() + 200) @AND !(nav_block == IndexOfBlock('Wait GPS'))
      @AND (nav_block @LT IndexOfBlock('landed')) @AND !(nav_block @LT IndexOfBlock('Holding point'))
      @AND !(nav_block == IndexOfBlock('Holding point'))" deroute="Terminate"/>
    <exception cond="(GpsIsLost() @AND (nav_block @GT IndexOfBlock('Standby'))
      @AND (nav_block @LT IndexOfBlock('landed')))" deroute="No_GPS_Connection"/>
  </exceptions>
  <blocks>
    <block name="Wait GPS">
      <call_once fun="NavKillThrottle()"/>
      <while cond="!GpsFixValid()"/>
    </block>
    <block name="Geo init">
      <while cond="LessThan(NavBlockTime(), 1)"/>
      <call_once fun="NavSetGroundReferenceHere()"/>
    </block>
    <block name="Holding point">
      <call_once fun="NavKillThrottle()"/>
      <attitude pitch="0" roll="0" throttle="0" until="FALSE" vmode="throttle"/>
    </block>
    <block name="Automatic Takeoff">
      <call_once fun="NavResurrect()"/>
      <call_once fun="take_off_enter()"/>
      <attitude alt="5" pitch="0" roll="0" until="GetPosHeight() @GT 2.0"/>
    </block>
    <block name="Takeoff" strip_button="Takeoff" strip_icon="takeoff.png">
      <exception cond="GetPosHeight() @GT 15.0" deroute="route"/>
      <call_once fun="NavSetWaypointHere(WP_CLIMB)"/>
      <stay climb="nav_climb_vspeed" vmode="climb" wp="CLIMB"/>
    </block>
    <block name="route">
      <set value="true" var="force_forward"/>
      <while cond="true">
        <go wp="h1"/>
        <go from="h1" hmode="route" wp="h2"/>
        <go from="h2" hmode="route" wp="h3"/>
        <go from="h3" hmode="route" wp="h4"/>
        <go from="h4" hmode="route" wp="h1"/>
      </while>
      <deroute block="stay_h1"/>
    </block>
    <block name="Standby" strip_button="Standby" strip_icon="home.png">
      <set value="false" var="force_forward"/>
      <stay wp="STDBY"/>
    </block>
    <block name="stay_h1">
      <set value="false" var="force_forward"/>
      <stay wp="h1"/>
    </block>
    <block name="go_p2">
      <set value="false" var="force_forward"/>
      <go wp="p2"/>
      <deroute block="stay_h1"/>
    </block>
    <block name="LowerALT">
      <set value="true" var="force_forward"/>
      <while cond="true">
        <go wp="L1"/>
        <go wp="L2"/>
        <go wp="L3"/>
        <go wp="L4"/>
      </while>
      <deroute block="land here"/>
    </block>
    <block name="go_start">
      <set value="false" var="force_forward"/>
      <go wp="START"/>
      <deroute block="route"/>
    </block>
    <block name="4waypoints">
      <set value="true" var="force_forward"/>
      <go wp="p1"/>
      <go wp="p2"/>
      <go wp="p3"/>
      <go wp="p4"/>
      <go wp="START"/>
      <deroute block="route"/>
    </block>
    <block name="land here" strip_button="Land Here" strip_icon="land-right.png">
      <call_once fun="NavSetWaypointHere(WP_TD)"/>
      <deroute block="flare"/>     
    </block>
    <block name="flare">
      <exception cond="LessThan(agl_dist_value_filtered, 0.15)" deroute="landed"/>
      <stay climb="nav_descend_vspeed" vmode="climb" wp="TD"/>
    </block>
    <block name="landed">
      <attitude pitch="0" roll="0" throttle="0" until="FALSE" vmode="throttle"/>
    </block>
    <block name="return home">
      <set value="false" var="force_forward"/>
      <go wp="STDBY"/>
    </block>
    <block name="Terminate">
      <call_once fun="NavKillThrottle()"/>
      <set value="false" var="force_forward"/>
      <set value="true" var="terminate_flight"/>
      <attitude pitch="0" roll="0" throttle="0" until="FALSE" vmode="throttle"/>
    </block>
    <block name="No_GPS_Connection">
      <attitude climb="-1" pitch="0" roll="0" vmode="climb"/>
      <exception cond="NavBlockTime() @GT 15" deroute="Terminate"/>
    </block>
  </blocks>
</flight_plan>
